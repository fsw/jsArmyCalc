var ArmyCalc=(function(){function a(c,b){var e=this;this.canvas=$(c);this.canvas.attr("style","");this.canvas.html("loading calc...");var d=$.ajax({url:b,async:false}).responseText;this.canvas.html(d);this.statusElem=this.canvas.find("#acStatus");this.submenuElem=this.canvas.find(".submenu");this.langSelect=this.canvas.find("#acLang");this.langSelect.change(function(){calc.setLang($(this).val())});this.canvas.find("#acMaximize").click(function(){e.setFullscreen(true);return false});this.canvas.find("#acMinimize").click(function(){e.setFullscreen(false);return false});this.canvas.find("#acNew").click(function(){e.newArmy();return false});this.canvas.find("#acRevalidate").click(function(){e.revalidate();return false});this.canvas.find("#acPrint").click(function(){e.print();return false});this.canvas.find("#acDec").click(function(){_focused_element.size(_focused_element.size()-1);return false}).hide();this.canvas.find("#acInc").click(function(){_focused_element.size(_focused_element.size()+1);return false}).hide();this.canvas.find("#acRem").click(function(){_focused_element.remove();return false}).hide();this.canvas.find("#acUp").click(function(){_focused_element._li.prev().before(_focused_element._li);calc.canvas.find("#acUp").toggle(_focused_element._li.prev().length>0);calc.canvas.find("#acDown").toggle(_focused_element._li.next().length>0);return false}).hide();this.canvas.find("#acDown").click(function(){_focused_element._li.next().after(_focused_element._li);calc.canvas.find("#acUp").toggle(_focused_element._li.prev().length>0);calc.canvas.find("#acDown").toggle(_focused_element._li.next().length>0);return false}).hide();this.twr=new a.TwrReader({onProgress:function(f){console.log("progress: "+f+"%")},onLoaded:function(){console.log("DONE")}});this.army=null}a.prototype={closePopup:function(){this.canvas.find("#acPopup").fadeOut();this.canvas.find("#acPopupBg").fadeOut()},popup:function(d,b,c){this.canvas.find("#acPopupTitle").html(d);this.canvas.find("#acPopupContent").html("");this.canvas.find("#acPopupContent").append(b);if(c){this.canvas.find("#acClosePopup").hide()}else{this.canvas.find("#acClosePopup").show()}this.canvas.find("#acPopupBg").fadeIn();this.canvas.find("#acPopup").fadeIn();this.canvas.find("#acClosePopup").click(function(){calc.canvas.find("#acPopup").fadeOut();calc.canvas.find("#acPopupBg").fadeOut();return false})},setStatus:function(b){this.statusElem.text(b)},flashMsg:function(b){this.statusElem.html(b);this.statusElem.stop().css("background-color","#ff0000").animate({backgroundColor:"#000000"},1000)},setLang:function(b){acAddCSSRule(".trans","display","none");if(this.lang){acAddCSSRule("."+this.lang+"","display","none")}this.lang=b;acAddCSSRule("."+b+"","display","inline")},setError:function(b){this.statusElem.html('<b style="color:red">'+b+"</b>")},calcLoadUnitsXml:function(b){console.log(b)},loadTWR:function(b){this.twr.load(b);this.setStatus("loading "+b)},revalidate:function(){if(!this.army){this.flashMsg("Please create new army first!");return}if(!this.model.validator){this.flashMsg("This model do not provide a validator!");return}acSandbox(this.model.validator,{army:this.army});this.popup("validation result",this.army._errorsul)},print:function(){if(!this.army){this.flashMsg("Please create new army first!");return}acPrintText(this.canvas.find(".unitslist").html())},newArmy:function(){that=this;var b=$("<div></div>");b.append("<div class='piece'><h3>"+this.twr.info.name+"</h3>"+this.twr.info.description+"</div>");var e=$("<select></select>");for(id in this.twr.armies){e.append("<option value='"+id+"'>"+this.twr.armies[id].name+"</option>")}var d=$("<input type='button' value='create'/>");b.append($("<label>Choose Army</label>").append(e));var c={};for(id in this.twr.costs){c[id]=$("<input name='cost["+id+"]' value='0'/>");b.append($("<label>"+this.twr.costs[id].name+"</label>").append(c[id]))}d.click(function(){that.closePopup();that.canvas.find("#acElements").html("");that.canvas.find("#acUnits").html("");that.armyTemplate=that.twr.armies[e.val()];that.army=new a.ArmyInstance(that.armyTemplate,{children:that.canvas.find("#acUnits"),detailsContainer:that.canvas.find("#acDetails"),availableContainer:that.canvas.find("#acAvailable"),});for(id in c){that.army.maxTotalCosts[id]=c[id].val()}function f(j,h,k){for(var m in h){if(h[m] instanceof a.ElementTemplate){var g=$("<a rel='"+m+"'href='#'>"+h[m].name+"</a>");j.append($("<li></li>").append(g));g.click(function(){var p=that.army;for(var n=0;n<k.length;n++){p=p.children[k[n]]}var o=p.appendElement($(this).attr("rel"));$(".submm").hide();o.focus();return false})}else{if(h[m] instanceof a.GroupTemplate){var l=$("<ul class='submm'></ul>");f(l,h[m].children,k.concat(m));var g=$("<a href='#'>"+h[m].name+"</a>");g.click(function(){return false});j.append($("<li></li>").append(g).append(l).hover(function(){$(this).children("ul").show()},function(){$(this).children("ul").hide()}))}}}}that.canvas.find("#acElements").html();f(that.canvas.find("#acElements"),that.army.template.children,[])});b.append($("<div class='submit'></div>").append(d));this.popup("New army - "+this.twr.info.name,b);e.focus()},setFullscreen:function(b){var c=this;$("body").toggleClass("acFullscreen",b);this.canvas.toggleClass("acFullscreen",b);this.canvas.find("#acMaximize").toggle(!b);this.canvas.find("#acMinimize").toggle(b);if(b){$(window).resize(function(){var d=$(window).height()-80;c.canvas.find(".unitslist").height(d)});$(window).resize()}else{this.canvas.find(".unitslist").height(200);$(window).unbind("resize")}},setEmbedded:function(b){if(b){this.setFullscreen(true);calc.canvas.find("#acMinimize").hide();calc.canvas.find(".buttons1").hide()}}};return a}).call({});if(navigator.appName!="Microsoft Internet Explorer"){window.onbeforeunload=function(a){}}(function(a){a.$=$})(ArmyCalc);(function(a){a.Template=(function(){function b(c,e,d){this.id=e;this.parent=c;if(d){this.stats={};this.clone(this.stats,d.stats);this.enabled=d.enabled;this.name=d.name;this.children={};for(var e in d.children){if(d.children[e] instanceof a.ElementTemplate){new a.ElementTemplate(this,e,d.children[e])}else{if(d.children[e] instanceof a.GroupTemplate){new a.GroupTemplate(this,e,d.children[e])}}}this.proto=d}else{this.children={};this.enabled=true;this.stats={};this.name="Unnamed"}if(c){c.children[e]=this}}b.prototype={clone:function(d,c){for(i in c){if(typeof c[i]!="object"){d[i]=c[i]}else{d[i]=this.clone({},c[i])}}return d},enable:function(c){template.enabled=true;return true},disable:function(){template.enabled=false;return true},append:function(c){},_loadFromXml:function(c){var d=null;if((d=c.children("name").text())||(d=c.attr("name"))){this.name=d}var e=null;if(e=c.children("description").text()){this.description=e}},_createAppender:function(c){var d=$('<a href="#">'+this.name+"</a>");var e=this;d.click(function(){c.appendElement(e.id);return false});return $("<li></li>").append(d)}};return b}).call({})})(ArmyCalc);(function(a){a.Instance=(function(){function b(f,e){var g=this;this.parent=f;this.template=e;this.available=e.children;this.children={};this.stats={};for(var d in e.stats){this.stats[d]=e.stats[d]}this.size=e.defaultSize;this.costs={};for(var d in e.costs){this.costs[d]=e.costs[d]*this.size;this.costs[d]=e.costs[d]*this.size}this.maxTotalCosts={};this.canvas={};if(f.canvas){this.canvas.children=f.canvas.children;this.canvas.availableContainer=f.canvas.availableContainer;this.canvas.detailsContainer=f.canvas.detailsContainer;if(typeof f.canvas.children!="undefined"){var c=$('<a href="#">'+e.name+"</a>");this.sizeSpan=$("<span> size </span>");this.li=$("<li></li>").append(c.prepend(this.sizeSpan));this.canvas.children=$("<ul></ul>");c.click(function(){g.focus()});f.canvas.children.append(this.li.append(this.canvas.children))}}this.canvas.available=$("<ul></ul>");this.canvas.details=$("<div> ... details ... </div>");for(var d in e.children){if(e.children[d] instanceof a.GroupTemplate){this.children[d]=new a.GroupInstance(this,e.children[d]);this.canvas.available.append("<li>GROUP</li>")}else{this.children[d]=[];this.canvas.available.append(e.children[d]._createAppender(this))}}}b.prototype={focus:function(){if(typeof this.canvas!="undefined"){this.li.parent().find("li").removeClass("current");this.li.addClass("current");this.canvas.availableContainer.html("");this.canvas.availableContainer.append(this.canvas.available);this.canvas.detailsContainer.html("");this.canvas.detailsContainer.append(this.canvas.details)}},resize:function(c){},appendElement:function(d){var c=new a.ElementInstance(this,this.template.children[d]);this.children[d].push(c);return c},remove:function(c){return true},setStat:function(c){return true},getStat:function(c){return true}};return b}).call({})})(ArmyCalc);(function(a){a.ElementTemplate=(function(){b.prototype=new a.Template();b.prototype.constructor=b;function b(c,e,d){a.Template.call(this,c,e,d);this.element=true}return b}).call({})})(ArmyCalc);(function(a){a.ElementInstance=(function(){b.prototype=new a.Instance({},{});b.prototype.constructor=b;function b(d,c){a.Instance.call(this,d,c)}return b}).call({})})(ArmyCalc);(function(a){a.GroupTemplate=(function(){b.prototype=new a.Template();b.prototype.constructor=b;function b(c,e,d){a.Template.call(this,c,e,d);this.group=true}return b}).call({})})(ArmyCalc);(function(a){a.GroupInstance=(function(){b.prototype=new a.Instance({},{});b.prototype.constructor=b;function b(d,c){a.Instance.call(this,d,c)}return b}).call({})})(ArmyCalc);(function(a){a.ArmyTemplate=(function(){b.prototype=new a.Template();b.prototype.constructor=b;function b(c,e,d){a.Template.call(this,c,e,d)}return b}).call({})})(ArmyCalc);(function(a){a.ArmyInstance=(function(){b.prototype=new a.Instance({},{});b.prototype.constructor=b;function b(d,c){a.Instance.call(this,{canvas:c},d)}b.prototype.getHtml=function(){return"Not <b>yet</b> implemented.HTML"};b.prototype.getTwa=function(){return"Not <b>yet</b> implemented.TWA"};return b}).call({})})(ArmyCalc);(function(a){a.TwrReader=(function(){function b(c){var d=Object.create(b.prototype);c=c||{};if(c.onProgress){d.onProgress=c.onProgress}if(c.onLoaded){d.onLoaded=c.onLoaded}d.clear();return(d)}b.onProgress=function(c){return null};b.prototype={clear:function(){this.identity={};this.languages={};this.info={};this.armies={};this.templatesByPath={};this.scripts=[];this.languages={};this.costs={};this.stats={};this.templatesQueue=[];this.languagesQueue=[];this.toLoadCount=0;this.noIdsCounter=0},load:function(d){var c=this;this.path=d;this.setProgress(0);$.get(this.path+"info.xml",function(e){c.loadInfoXml(e)},"xml");return true},issueWarning:function(c){console.log("WARNING: "+c)},setProgress:function(c){if(this.onProgress){this.onProgress(c)}},loadInfoXml:function(f){var e=this;this.clear();var f=$(f).children("ruleset");this.identity.uid=$(f).children("identity").children("uid").text();this.identity.revision=$(f).children("identity").children("revision").text();this.identity.origin=$(f).children("identity").children("origin").text();this.identity.url=$(f).children("identity").children("url").text();this.info.name=$(f).children("info").children("name").text();this.info.author={name:$(f).children("info").children("author").children("name").text(),email:$(f).children("info").children("author").children("email").text()};this.info.description=$(f).children("info").children("description").text();$(f).children("costs").children("cost").each(function(){$this=$(this);var h={};h.name=$this.children("name").text();h.shortname=$this.children("shortname").text();h.suffix=$this.children("suffix").text();h.prefix=$this.children("prefix").text();h["default"]=$this.children("default").text();e.costs[$this.attr("id")]=h});$(f).children("stats").children("stat").each(function(){$this=$(this);var h={};h.name=$this.children("name").text();h.shortname=$this.children("shortname").text();h.suffix=$this.children("suffix").text();h.prefix=$this.children("prefix").text();h["default"]=($this.attr("default")=="true");e.stats[$this.attr("id")]=h});var d=$(f).children("data").children("templates").children("templates");d.each(function(j,k){if($(k).attr("src")){e.templatesQueue.push($(k).attr("src"));var h=e.templatesQueue.length-1;e.toLoadCount++;$.ajax({url:e.path+$(k).attr("src"),success:function(l){$(l).children("templates").each(function(){e.templatesQueue[h]=this});e.fileLoaded()},error:function(l,m){e.templatesQueue[h]=null;e.issueWarning("error loading file "+$(k).attr("src")+"("+m+")");e.fileLoaded()},dataType:"xml"})}else{e.templatesQueue.push(k)}});var c=$(f).children("data").children("scripts").children("script");c.each(function(j,k){if($(k).attr("src")){e.scripts.push($(k).attr("src"));var h=e.scripts.length-1;e.toLoadCount++;$.ajax({url:e.path+$(k).attr("src"),success:function(l){e.scripts[h]=l;e.fileLoaded()},error:function(l,m){e.scripts[h]="";e.issueWarning("error loading file "+$(k).attr("src")+"("+m+")");e.fileLoaded()},dataType:"text"})}else{e.scripts.push($(k).text())}});var g=$(f).children("data").children("languages").children("language");g.each(function(j,k){if($(k).attr("src")){e.languagesQueue.push($(k).attr("src"));var h=e.languagesQueue.length-1;e.toLoadCount++;$.ajax({url:e.path+$(k).attr("src"),success:function(l){e.languagesQueue[h]=$(l).children("language").first();e.fileLoaded()},error:function(l,m){e.languagesQueue[h]=null;e.issueWarning("error loading file "+$(k).attr("src")+"("+m+")");e.fileLoaded()},dataType:"xml"})}else{e.languagesQueue.push(k)}});this.toLoadCount++;this.fileLoaded()},fileLoaded:function(){this.toLoadCount--;var c=this.templatesQueue.length+this.scripts.length+this.languagesQueue.length;this.setProgress(((c-this.toLoadCount)/c)*50);if(this.toLoadCount==0){this.loadFiles()}},fileProcessed:function(){this.toProcessCount--;this.setProgress(50+(((this.toProcessAll-this.toProcessCount)/this.toProcessAll)*50))},loadFiles:function(){var d=this;this.setProgress(50);this.children={};this.toProcessAll=this.toProcessCount=this.templatesQueue.length+this.languagesQueue.length+this.scripts.length;for(var c=0;c<this.templatesQueue.length;c++){this.appendTemplates(this.templatesQueue[c],this,"");this.fileProcessed()}this.setProgress(100)},appendTemplates:function(d,c,f){var e=this;var g=0;$(d).children("army, group, element, deadend").each(function(j,n){g++;var l=n.nodeName.toLowerCase();var m=null;var h;if(h=$(n).attr("prototype")){m=e.templatesByPath[h];if(!m){e.issueWarning("cant find prototype "+h)}}var o=o=$(n).attr("id");if(!o&&m){o=m.id}if(!o){o=g}switch(l){case"element":var k=new a.ElementTemplate(c,o,m);break;case"group":var k=new a.GroupTemplate(c,o,m);break;case"army":var k=new a.ArmyTemplate(c,o,m);break;case"deadend":delete c.children[o];return;default:return}k._loadFromXml($(n));e.templatesByPath[f+o]=k;e.appendTemplates(n,k,f+o+".");if(k instanceof a.ArmyTemplate){e.armies[o]=k}})},save:function(){var c=b.buildXml({identity:this.identity});this.putFile("info",c);return true},loaded:function(){alert("loaded")}};return(b)}).call({})})(ArmyCalc);function acAddCSSRule(b,a,c){for(var e=0;e<document.styleSheets.length;e++){var h=document.styleSheets[e];var g=(h.cssRules||h.rules);var j=b.toLowerCase();for(var d=0,f=g.length;d<f;d++){if(g[d].selectorText&&(g[d].selectorText.toLowerCase()==j)){if(c!=null){g[d].style[a]=c;return}else{if(h.deleteRule){h.deleteRule(d)}else{if(h.removeRule){h.removeRule(d)}else{g[d].style.cssText=""}}}}}}var h=document.styleSheets[0]||{};if(h.insertRule){var g=(h.cssRules||h.rules);h.insertRule(b+"{ "+a+":"+c+"; }",g.length)}else{if(h.addRule){h.addRule(b,a+":"+c+";",0)}}}function acGetText(a){txt="";$(a).contents().each(function(){if((this.nodeType==3)&&(!this.isElementContentWhitespace)){txt+=this.wholeText}if((this.nodeType!=3)){txt+="<span class='trans "+$(this).attr("ln")+"'>"+$(this).text()+"</span>"}});return $.trim(txt)}(function(g){g.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","color","outlineColor"],function(a,b){g.fx.step[b]=function(c){if(!c.colorInit){c.start=h(c.elem,b);c.end=e(c.end);c.colorInit=true}c.elem.style[b]="rgb("+[Math.max(Math.min(parseInt((c.pos*(c.end[0]-c.start[0]))+c.start[0]),255),0),Math.max(Math.min(parseInt((c.pos*(c.end[1]-c.start[1]))+c.start[1]),255),0),Math.max(Math.min(parseInt((c.pos*(c.end[2]-c.start[2]))+c.start[2]),255),0)].join(",")+")"}});function e(a){var b;if(a&&a.constructor==Array&&a.length==3){return a}if(b=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(a)){return[parseInt(b[1]),parseInt(b[2]),parseInt(b[3])]}if(b=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(a)){return[parseFloat(b[1])*2.55,parseFloat(b[2])*2.55,parseFloat(b[3])*2.55]}if(b=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(a)){return[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]}if(b=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(a)){return[parseInt(b[1]+b[1],16),parseInt(b[2]+b[2],16),parseInt(b[3]+b[3],16)]}if(b=/rgba\(0, 0, 0, 0\)/.exec(a)){return f.transparent}return f[g.trim(a).toLowerCase()]}function h(a,c){var b;do{b=g.curCSS(a,c);if(b!=""&&b!="transparent"||g.nodeName(a,"body")){break}c="backgroundColor"}while(a=a.parentNode);return e(b)}var f={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]}})(jQuery);function acClone(b){var a=(this instanceof Array)?[]:{};for(i in b){if(typeof b[i]=="object"){a[i]=acClone(b[i])}else{a[i]=b[i]}}return a}function acPrintText(b){var a=window.open("","TrackHistoryData","width=420,height=225,top=250,left=345,toolbars=no,scrollbars=no,status=no,resizable=no");a.document.write(b);a.document.close();a.focus();a.print();a.close()}function acSandbox(a,b){new Function("window","with(window){"+a+"}")(b)};