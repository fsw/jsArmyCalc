var ArmyCalc=(function(){function a(c,b){calc={};calc.canvas=$(c);calc.canvas.attr("style","");calc.canvas.html("loading calc...");var d=$.ajax({url:b,async:false}).responseText;calc.canvas.html(d);calc.statusElem=calc.canvas.find("#acStatus");calc.submenuElem=calc.canvas.find(".submenu");calc.langSelect=calc.canvas.find("#acLang");calc.langSelect.change(function(){calc.setLang($(this).val())});calc.canvas.find("#acMaximize").click(function(){calc.setFullscreen(true);return false});calc.canvas.find("#acMinimize").click(function(){calc.setFullscreen(false);return false});calc.canvas.find("#acNew").click(function(){calc.newArmy();return false});calc.canvas.find("#acRevalidate").click(function(){calc.revalidate();return false});calc.canvas.find("#acPrint").click(function(){calc.print();return false});calc.canvas.find("#acDec").click(function(){_focused_element.size(_focused_element.size()-1);return false}).hide();calc.canvas.find("#acInc").click(function(){_focused_element.size(_focused_element.size()+1);return false}).hide();calc.canvas.find("#acRem").click(function(){_focused_element.remove();return false}).hide();calc.canvas.find("#acUp").click(function(){_focused_element._li.prev().before(_focused_element._li);calc.canvas.find("#acUp").toggle(_focused_element._li.prev().length>0);calc.canvas.find("#acDown").toggle(_focused_element._li.next().length>0);return false}).hide();calc.canvas.find("#acDown").click(function(){_focused_element._li.next().after(_focused_element._li);calc.canvas.find("#acUp").toggle(_focused_element._li.prev().length>0);calc.canvas.find("#acDown").toggle(_focused_element._li.next().length>0);return false}).hide();calc.army=null;calc.units=[];calc.availableUnits={};calc.closePopup=function(){this.canvas.find("#acPopup").fadeOut();this.canvas.find("#acPopupBg").fadeOut()};calc.popup=function(g,e,f){this.canvas.find("#acPopupTitle").html(g);this.canvas.find("#acPopupContent").html("");this.canvas.find("#acPopupContent").append(e);if(f){this.canvas.find("#acClosePopup").hide()}else{this.canvas.find("#acClosePopup").show()}this.canvas.find("#acPopupBg").fadeIn();this.canvas.find("#acPopup").fadeIn();this.canvas.find("#acClosePopup").click(function(){calc.canvas.find("#acPopup").fadeOut();calc.canvas.find("#acPopupBg").fadeOut();return false})};calc.setStatus=function(e){this.statusElem.text(e)};calc.flashMsg=function(e){this.statusElem.html(e);this.statusElem.stop().css("background-color","#ff0000").animate({backgroundColor:"#000000"},1000)};calc.setLang=function(e){acAddCSSRule(".trans","display","none");if(this.lang){acAddCSSRule("."+this.lang+"","display","none")}this.lang=e;acAddCSSRule("."+e+"","display","inline")};calc.setStatus("no TWR file loaded");calc.setError=function(e){this.statusElem.html('<b style="color:red">'+e+"</b>")};xhrError=function(g,f,e){this.calc.setError(this.url+" - "+f+" - "+e)};calc.calcLoadUnitsXml=function(e){console.log(e)};calc.loadTWR=function(e){this.twrurl=e;this.units=[];this.availableUnits=[];this.setStatus("loading "+e);this.ruleset=new acRuleset(this);this.ruleset.loadFromUrl(e)};calc.revalidate=function(){if(!this.army){this.flashMsg("Please create new army first!");return}if(!this.model.validator){this.flashMsg("This model do not provide a validator!");return}acSandbox(this.model.validator,{army:this.army});this.popup("validation result",this.army._errorsul)};calc.getArmyHtml=function(){if(!this.army){this.flashMsg("Please create new army first!");return false}return"Not <b>yet</b> implemented.HTML"};calc.getArmyTwa=function(){if(!this.army){this.flashMsg("Please create new army first!");return false}return"Not <b>yet</b> implemented.TWA"};calc.print=function(){if(!this.army){this.flashMsg("Please create new army first!");return}acPrintText(this.canvas.find(".unitslist").html())};calc.newArmy=function(){that=this;body=$("<div></div>");body.append("<div class='piece'><h3>"+this.ruleset.name+"</h3>"+this.ruleset.description+"</div>");modelSelect=$("<select></select>");for(id in this.ruleset.models){modelSelect.append("<option value='"+id+"'"+(this.ruleset.models[id]["default"]?" selected='true'":"")+">"+this.ruleset.models[id].name+"</option>")}createButton=$("<input type='button' value='create'/>");body.append($("<label>Model</label>").append(modelSelect));for(id in this.ruleset.costs){this.ruleset.costs[id].input=$("<input name='cost["+id+"]' value='0'/>");body.append($("<label>"+this.ruleset.costs[id].name+"</label>").append(this.ruleset.costs[id].input))}createButton.click(function(){calc.closePopup();calc.canvas.find("#acElements").html("");calc.canvas.find("#acUnits").html("");var f=$("<div class='title'></div>");$.each(that.ruleset.costs,function(h,g){f.append("<span class='cst'>"+g.shortname+"</span>")});$.each(that.ruleset.stats,function(h,g){f.append("<span class='st'>"+g.shortname+"</span>")});calc.canvas.find("#acUnitsHeader").html("");calc.canvas.find("#acUnitsHeader").append(f);calc.model=that.ruleset.models[modelSelect.val()];calc.army=new acInstance(that,that.ruleset,null,calc.model);calc.army.maxCosts={};for(id in calc.ruleset.costs){calc.army.maxCosts[id]=that.ruleset.costs[id].input.val()}var e={};$.each(calc.model.mainmenu,function(j,h){e[j]=$("<ul class='submm'></ul>");var g=$("<a href='#'>"+h.name+"</a>");calc.canvas.find("#acElements").append($("<li></li>").append(g).append(e[j]).hover(function(){$(this).children("ul").show()},function(){$(this).children("ul").hide()}));$.each(h.submenus,function(m,l){e[m]=$("<ul class='submm'></ul>");var k=$("<a href='#'>"+l.name+"</a>");e[j].append($("<li></li>").append(k).append(e[m]).hover(function(){$(this).children("ul").show()},function(){$(this).children("ul").hide()}))})});$.each(calc.army.element.elements,function(h,g){$.each(g.elements,function(l,k){if(k.menu_id){var j=$("<a href='#'>"+k.name+"</a>");e[k.menu_id].append($("<li></li>").append(j));j.click(function(){calc.army.append(l);$(".submm").hide()})}})});$.each(e,function(h,g){if($(g).children("li").length==0){$(g).parent().remove()}})});body.append($("<div class='submit'></div>").append(createButton));this.popup("New army - "+this.ruleset.name,body)};calc.setFullscreen=function(e){var f=this;$("body").toggleClass("acFullscreen",e);this.canvas.toggleClass("acFullscreen",e);this.canvas.find("#acMaximize").toggle(!e);this.canvas.find("#acMinimize").toggle(e);if(e){$(window).resize(function(){var g=$(window).height()-80;f.canvas.find(".unitslist").height(g)});$(window).resize()}else{this.canvas.find(".unitslist").height(200);$(window).unbind("resize")}};calc.setEmbedded=function(e){if(e){this.setFullscreen(true);calc.canvas.find("#acMinimize").hide();calc.canvas.find(".buttons1").hide()}};return calc}return a}).call({});function goodbye(a){}if(navigator.appName!="Microsoft Internet Explorer"){window.onbeforeunload=goodbye}(function(a){a.$=$})(ArmyCalc);(function(a){a.Instance=(function(){function b(d){var c={};c.t=d;c.children=[];c.stats={};return c}b.injectClassMethods=function(d){for(var c in TwrReader.prototype){if(TwrReader.prototype.hasOwnProperty(c)){d[c]=TwrReader.prototype[c]}}return(d)};b.prototype={resize:function(c){},append:function(c){return true},remove:function(c){return true},setStat:function(c){return true},getStat:function(c){return true}};return b}).call({})})(ArmyCalc);(function(a){a.Template=(function(){function b(c){var d={};d.parent=null;d.children={};d.id="";d.enabled=true;d.stats=true;return d}b.prototype={enable:function(c){template.enabled=true;return true},disable:function(){template.enabled=false;return true},append:function(c){}};return b}).call({})})(ArmyCalc);(function(a){a.TwrReader=(function(){function b(c){var d=Object.create(b.prototype);c=c||{};if(c.onProgress){d.onProgress=c.onProgress}if(c.onLoaded){d.onLoaded=c.onLoaded}d.filesQueue=[];d.identity={};d.languages={};d.info={};d.files={};d.armies={};return(d)}b.putFile=function(d,c){throw"Error"};b.parseXML=function(f){var c,d;try{if(window.DOMParser){d=new DOMParser();c=d.parseFromString(f,"text/xml")}else{c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";c.loadXML(f)}}catch(g){c=undefined}if(!c||!c.documentElement||c.getElementsByTagName("parsererror").length){throw"Invalid XML"}return c};b.buildXml=function(c){xml="<?xml?>";return xml};b.onProgress=function(c){return null};b.prototype={load:function(d){var c=this;this.path=d;if(this.onProgress){this.onProgress(0)}$.get(this.path+"info.xml",function(e){c.loadInfoXml(e)},"xml");return true},loadInfoXml:function(c){alert($(c).children("name").length);if(this.onProgress){this.onProgress(100)}},save:function(){var c=b.buildXml({identity:this.identity,});this.putFile("info",c);return true},loaded:function(){alert("loaded")},getFile:function(c){throw"Error";$.get(this.path+c,callback,"text")},getFileXml:function(d){this.filesQueue.push({path:d});var c=this;$.get(this.path+d,function(e){c.processFiles(d,e)},"xml")},processFiles:function(e,d){for(var c=0;c<this.filesQueue.length;c++){if(this.filesQueue[c].path==e){this.filesQueue[c].data=d}}}};return(b)}).call({})})(ArmyCalc);function acAddCSSRule(b,a,c){for(var e=0;e<document.styleSheets.length;e++){var h=document.styleSheets[e];var g=(h.cssRules||h.rules);var j=b.toLowerCase();for(var d=0,f=g.length;d<f;d++){if(g[d].selectorText&&(g[d].selectorText.toLowerCase()==j)){if(c!=null){g[d].style[a]=c;return}else{if(h.deleteRule){h.deleteRule(d)}else{if(h.removeRule){h.removeRule(d)}else{g[d].style.cssText=""}}}}}}var h=document.styleSheets[0]||{};if(h.insertRule){var g=(h.cssRules||h.rules);h.insertRule(b+"{ "+a+":"+c+"; }",g.length)}else{if(h.addRule){h.addRule(b,a+":"+c+";",0)}}}function acGetText(a){txt="";$(a).contents().each(function(){if((this.nodeType==3)&&(!this.isElementContentWhitespace)){txt+=this.wholeText}if((this.nodeType!=3)){txt+="<span class='trans "+$(this).attr("ln")+"'>"+$(this).text()+"</span>"}});return $.trim(txt)}(function(g){g.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","color","outlineColor"],function(a,b){g.fx.step[b]=function(c){if(!c.colorInit){c.start=h(c.elem,b);c.end=e(c.end);c.colorInit=true}c.elem.style[b]="rgb("+[Math.max(Math.min(parseInt((c.pos*(c.end[0]-c.start[0]))+c.start[0]),255),0),Math.max(Math.min(parseInt((c.pos*(c.end[1]-c.start[1]))+c.start[1]),255),0),Math.max(Math.min(parseInt((c.pos*(c.end[2]-c.start[2]))+c.start[2]),255),0)].join(",")+")"}});function e(a){var b;if(a&&a.constructor==Array&&a.length==3){return a}if(b=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(a)){return[parseInt(b[1]),parseInt(b[2]),parseInt(b[3])]}if(b=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(a)){return[parseFloat(b[1])*2.55,parseFloat(b[2])*2.55,parseFloat(b[3])*2.55]}if(b=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(a)){return[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]}if(b=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(a)){return[parseInt(b[1]+b[1],16),parseInt(b[2]+b[2],16),parseInt(b[3]+b[3],16)]}if(b=/rgba\(0, 0, 0, 0\)/.exec(a)){return f.transparent}return f[g.trim(a).toLowerCase()]}function h(a,c){var b;do{b=g.curCSS(a,c);if(b!=""&&b!="transparent"||g.nodeName(a,"body")){break}c="backgroundColor"}while(a=a.parentNode);return e(b)}var f={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]}})(jQuery);function acClone(b){var a=(this instanceof Array)?[]:{};for(i in b){if(typeof b[i]=="object"){a[i]=acClone(b[i])}else{a[i]=b[i]}}return a}function acPrintText(b){var a=window.open("","TrackHistoryData","width=420,height=225,top=250,left=345,toolbars=no,scrollbars=no,status=no,resizable=no");a.document.write(b);a.document.close();a.focus();a.print();a.close()}function acSandbox(a,b){new Function("window","with(window){"+a+"}")(b)};