var ArmyCalc=(function(){function a(c,b){var f=this;this.canvas=$(c);this.canvas.attr("style","");this.canvas.html("loading calc...");var e=$.ajax({url:b,async:false}).responseText;this.canvas.html(e);this.statusElem=this.canvas.find("#acStatus");this.submenuElem=this.canvas.find(".submenu");this.langSelect=this.canvas.find("#acLang");this.langSelect.change(function(){calc.setLang($(this).val())});this.canvas.find("#acMaximize").click(function(){f.setFullscreen(true);return false});this.canvas.find("#acMinimize").click(function(){f.setFullscreen(false);return false});this.canvas.find("#acNew").click(function(){f.newArmy();return false});this.canvas.find("#acRevalidate").click(function(){f.revalidate();return false});this.canvas.find("#acPrint").click(function(){f.print();return false});this.canvas.find("#acDec").click(function(){_focused_element.decSize();return false}).hide();this.canvas.find("#acInc").click(function(){_focused_element.incSize();return false}).hide();this.canvas.find("#acRem").click(function(){_focused_element.remove();return false}).hide();this.canvas.find("#acUp").click(function(){_focused_element._li.prev().before(_focused_element._li);calc.canvas.find("#acUp").toggle(_focused_element._li.prev().length>0);calc.canvas.find("#acDown").toggle(_focused_element._li.next().length>0);return false}).hide();this.canvas.find("#acDown").click(function(){_focused_element._li.next().after(_focused_element._li);calc.canvas.find("#acUp").toggle(_focused_element._li.prev().length>0);calc.canvas.find("#acDown").toggle(_focused_element._li.next().length>0);return false}).hide();this.twr=new a.TwrReader({onProgress:function(g){f.setStatus("loading "+f.twrUrl+" ("+Math.round(g)+"%)")},onLoaded:function(){f.setStatus(f.twrUrl+" loaded.")}});this.army=null}a.prototype={closePopup:function(){this.canvas.find("#acPopup").fadeOut();this.canvas.find("#acPopupBg").fadeOut()},popup:function(e,b,c){this.canvas.find("#acPopupTitle").html(e);this.canvas.find("#acPopupContent").html("");this.canvas.find("#acPopupContent").append(b);if(c){this.canvas.find("#acClosePopup").hide()}else{this.canvas.find("#acClosePopup").show()}this.canvas.find("#acPopupBg").fadeIn();this.canvas.find("#acPopup").fadeIn();this.canvas.find("#acClosePopup").click(function(){calc.canvas.find("#acPopup").fadeOut();calc.canvas.find("#acPopupBg").fadeOut();return false})},setStatus:function(b){this.statusElem.text(b)},flashMsg:function(b){this.statusElem.html(b);this.statusElem.stop().css("background-color","#ff0000").animate({backgroundColor:"#000000"},1000)},setLang:function(b){acAddCSSRule(".trans","display","none");if(this.lang){acAddCSSRule("."+this.lang+"","display","none")}this.lang=b;acAddCSSRule("."+b+"","display","inline")},setError:function(b){this.statusElem.html('<b style="color:red">'+b+"</b>")},loadTWR:function(b){this.twrUrl=b;this.twr.load(this.twrUrl)},revalidate:function(){if(!this.army){this.flashMsg("Please create new army first!");return}if(!this.model.validator){this.flashMsg("This model do not provide a validator!");return}acSandbox(this.model.validator,{army:this.army});this.popup("validation result",this.army._errorsul)},print:function(){if(!this.army){this.flashMsg("Please create new army first!");return}acPrintText(this.canvas.find(".unitslist").html())},newArmy:function(){that=this;var b=$("<div></div>");b.append("<div class='piece'><h3>"+this.twr.info.name+"</h3>"+this.twr.info.description+"</div>");var f=$("<select></select>");for(id in this.twr.armies){f.append("<option value='"+id+"'>"+this.twr.armies[id].name+"</option>")}var e=$("<input type='button' value='create'/>");b.append($("<label>Choose Army</label>").append(f));var c={};for(id in this.twr.costs){c[id]=$("<input name='cost["+id+"]' value='0'/>");b.append($("<label>"+this.twr.costs[id].name+"</label>").append(c[id]))}e.click(function(){that.closePopup();that.canvas.find("#acElements").html("");that.canvas.find("#acUnits").html("");that.armyTemplate=that.twr.armies[f.val()];that.army=new a.ArmyInstance(that.armyTemplate,{children:that.canvas.find("#acUnits"),detailsContainer:that.canvas.find("#acDetails"),availableContainer:that.canvas.find("#acAvailable"),buttons:{dec:that.canvas.find("#acDec"),inc:that.canvas.find("#acInc"),rem:that.canvas.find("#acRem"),up:that.canvas.find("#acUp"),down:that.canvas.find("#acDown")}});for(id in c){that.army.maxTotalCosts[id]=c[id].val()}});b.append($("<div class='submit'></div>").append(e));this.popup("New army - "+this.twr.info.name,b);f.focus()},setFullscreen:function(b){var c=this;$("body").toggleClass("acFullscreen",b);this.canvas.toggleClass("acFullscreen",b);this.canvas.find("#acMaximize").toggle(!b);this.canvas.find("#acMinimize").toggle(b);if(b){$(window).resize(function(){var e=$(window).height()-80;c.canvas.find(".unitslist").height(e)});$(window).resize()}else{this.canvas.find(".unitslist").height(200);$(window).unbind("resize")}},setEmbedded:function(b){if(b){this.setFullscreen(true);calc.canvas.find("#acMinimize").hide();calc.canvas.find(".buttons1").hide()}}};return a}).call({});if(navigator.appName!="Microsoft Internet Explorer"){window.onbeforeunload=function(a){}}(function(a){a.$=$})(ArmyCalc);(function(a){a.Template=(function(){function b(c,f,e){this.id=f;this.parent=c;if(e){this.stats={};this.clone(this.stats,e.stats);this.enabled=e.enabled;this.name=e.name;this.minSize=e.minSize;this.maxSize=e.minSize;this.defaultSize=e.defaultSize;this.children={};for(var f in e.children){if(e.children[f] instanceof a.ElementTemplate){new a.ElementTemplate(this,f,e.children[f])}else{if(e.children[f] instanceof a.GroupTemplate){new a.GroupTemplate(this,f,e.children[f])}}}this.proto=e}else{this.children={};this.enabled=true;this.stats={};this.name="Unnamed";this.minSize=1;this.maxSize=null;this.defaultSize=1}if(c){c.children[this.id]=this}}b.prototype={clone:function(e,c){for(i in c){if(typeof c[i]!="object"){e[i]=c[i]}else{e[i]=this.clone({},c[i])}}return e},enable:function(c){template.enabled=true;return true},disable:function(){template.enabled=false;return true},append:function(c){},_loadFromXml:function(c){(n=c.children("name").text())||(n=c.attr("name"));if(typeof n!="undefined"){this.name=n}(d=c.children("description").text());if(typeof d!="undefined"){this.description=n}(min=c.attr("minSize"));if(typeof min!="undefined"){this.minSize=parseInt(min);this.defaultSize=this.minSize}(max=c.attr("maxSize"));if(typeof max!="undefined"){this.maxSize=parseInt(max)}(def=c.attr("defaultSize"));if(typeof def!="undefined"){this.defaultSize=parseInt(def)}},_createAppender:function(c){var e=$('<a href="#">'+this.name+"</a>");var f=this;e.click(function(){c.appendElement(f.id);return false});return $("<li></li>").append(e)}};return b}).call({})})(ArmyCalc);(function(a){a.Instance=(function(){function b(g,f){var h=this;if(g instanceof a.Instance){this.parent=g}this.template=f;this.available=f.children;this.children={};this.stats={};for(var e in f.stats){this.stats[e]=f.stats[e]}this.maxTotalCosts={};this.canvas={};if(g.canvas){this.canvas.children=g.canvas.children;this.canvas.availableContainer=g.canvas.availableContainer;this.canvas.detailsContainer=g.canvas.detailsContainer;this.canvas.buttons=g.canvas.buttons;if(typeof g.canvas.children!="undefined"){var c=$('<a href="#">'+f.name+"</a>");this.sizeSpan=$("<span></span>");this.folder=$('<span class="folder">&nbsp;</span>');c.prepend(this.sizeSpan);c.prepend(this.folder);this.li=$("<li></li>").append(c);this.canvas.children=$("<ul></ul>");c.click(function(){h.focus()});this.folder.click(function(){h.toggleFold()});g.canvas.children.append(this.li.append(this.canvas.children))}}this.canvas.available=$("<ul></ul>");this.canvas.details=$("<div> ... details ... </div>");this.costs={};if(this.parent){this.setSize(f.defaultSize)}for(var e in f.children){if(f.children[e] instanceof a.GroupTemplate){console.log("adding "+e+" to "+this.template.id);this.children[e]=new a.GroupInstance(this,f.children[e])}else{console.log("adding "+e+" to "+this.template.id);this.children[e]=[];this.canvas.available.append(f.children[e]._createAppender(this))}}this.childrenCountChanged();if(this.parent){this.parent.childrenCountChanged()}}b.prototype={toggleFold:function(){this.folder.toggleClass("unfold");this.canvas.children.toggle()},unfocus:function(){this.li.removeClass("current");if(this.parent){this.parent.unfocus()}},focus:function(c){if((!c)&&(typeof _focused_element!="undefined")){_focused_element.unfocus()}this.li.addClass("current");if(this.parent){this.parent.focus(true)}if(!c){this.canvas.availableContainer.html("");this.canvas.availableContainer.append(this.canvas.available);this.canvas.detailsContainer.html("");this.canvas.detailsContainer.append(this.canvas.details);this.canvas.buttons.inc.toggle(true);this.canvas.buttons.dec.toggle(true);this.canvas.buttons.rem.toggle(true);this.canvas.buttons.up.toggle(true);this.canvas.buttons.down.toggle(true);_focused_element=this}},getSize:function(){return this.size},setSize:function(e){this.size=e;for(var c in this.template.costs){this.costs[c]=template.costs[c]*this.size;this.costs[c]=template.costs[c]*this.size}if(this.size>1){this.sizeSpan.text(this.size+"x")}else{this.sizeSpan.text("")}},incSize:function(){this.setSize(this.getSize()+1)},decSize:function(){this.setSize(this.getSize()-1)},childrenCountChanged:function(){if(this.folder){this.folder.toggle(Object.keys(this.children).length>0)}},appendElement:function(e){var c=new a.ElementInstance(this,this.template.children[e]);this.children[e].push(c);return c},remove:function(c){return true},setStat:function(c){return true},getStat:function(c){return true}};return b}).call({})})(ArmyCalc);(function(a){a.ElementTemplate=(function(){b.prototype=new a.Template();b.prototype.constructor=b;function b(c,f,e){a.Template.call(this,c,f,e);this.element=true}return b}).call({})})(ArmyCalc);(function(a){a.ElementInstance=(function(){b.prototype=new a.Instance({},{});b.prototype.constructor=b;function b(e,c){a.Instance.call(this,e,c)}return b}).call({})})(ArmyCalc);(function(a){a.GroupTemplate=(function(){b.prototype=new a.Template();b.prototype.constructor=b;function b(c,f,e){a.Template.call(this,c,f,e);this.group=true}return b}).call({})})(ArmyCalc);(function(a){a.GroupInstance=(function(){b.prototype=new a.Instance({},{});b.prototype.constructor=b;function b(e,c){a.Instance.call(this,e,c)}return b}).call({})})(ArmyCalc);(function(a){a.ArmyTemplate=(function(){b.prototype=new a.Template();b.prototype.constructor=b;function b(c,f,e){a.Template.call(this,c,f,e)}return b}).call({})})(ArmyCalc);(function(a){a.ArmyInstance=(function(){b.prototype=new a.Instance({},{});b.prototype.constructor=b;function b(e,c){a.Instance.call(this,{canvas:c},e)}b.prototype.getHtml=function(){return"Not <b>yet</b> implemented.HTML"};b.prototype.getTwa=function(){return"Not <b>yet</b> implemented.TWA"};return b}).call({})})(ArmyCalc);(function(a){a.TwrReader=(function(){function b(c){var e=Object.create(b.prototype);c=c||{};if(c.onProgress){e.onProgress=c.onProgress}if(c.onLoaded){e.onLoaded=c.onLoaded}e.clear();return(e)}b.onProgress=function(c){return null};b.prototype={clear:function(){this.identity={};this.languages={};this.info={};this.armies={};this.templatesByPath={};this.scripts=[];this.languages={};this.costs={};this.stats={};this.templatesQueue=[];this.languagesQueue=[];this.toLoadCount=0;this.noIdsCounter=0},load:function(e){var c=this;this.path=e;this.setProgress(0);$.get(this.path+"info.xml",function(f){c.loadInfoXml(f)},"xml");return true},issueWarning:function(c){console.log("WARNING: "+c)},setProgress:function(c){if(this.onProgress){this.onProgress(c)}},loadInfoXml:function(g){var f=this;this.clear();var g=$(g).children("ruleset");this.identity.uid=$(g).children("identity").children("uid").text();this.identity.revision=$(g).children("identity").children("revision").text();this.identity.origin=$(g).children("identity").children("origin").text();this.identity.url=$(g).children("identity").children("url").text();this.info.name=$(g).children("info").children("name").text();this.info.author={name:$(g).children("info").children("author").children("name").text(),email:$(g).children("info").children("author").children("email").text()};this.info.description=$(g).children("info").children("description").text();$(g).children("costs").children("cost").each(function(){$this=$(this);var j={};j.name=$this.children("name").text();j.shortname=$this.children("shortname").text();j.suffix=$this.children("suffix").text();j.prefix=$this.children("prefix").text();j["default"]=$this.children("default").text();f.costs[$this.attr("id")]=j});$(g).children("stats").children("stat").each(function(){$this=$(this);var j={};j.name=$this.children("name").text();j.shortname=$this.children("shortname").text();j.suffix=$this.children("suffix").text();j.prefix=$this.children("prefix").text();j["default"]=($this.attr("default")=="true");f.stats[$this.attr("id")]=j});var e=$(g).children("data").children("templates").children("templates");e.each(function(k,l){if($(l).attr("src")){f.templatesQueue.push($(l).attr("src"));var j=f.templatesQueue.length-1;f.toLoadCount++;$.ajax({url:f.path+$(l).attr("src"),success:function(m){$(m).children("templates").each(function(){f.templatesQueue[j]=this});f.fileLoaded()},error:function(m,o){f.templatesQueue[j]=null;f.issueWarning("error loading file "+$(l).attr("src")+"("+o+")");f.fileLoaded()},dataType:"xml"})}else{f.templatesQueue.push(l)}});var c=$(g).children("data").children("scripts").children("script");c.each(function(k,l){if($(l).attr("src")){f.scripts.push($(l).attr("src"));var j=f.scripts.length-1;f.toLoadCount++;$.ajax({url:f.path+$(l).attr("src"),success:function(m){f.scripts[j]=m;f.fileLoaded()},error:function(m,o){f.scripts[j]="";f.issueWarning("error loading file "+$(l).attr("src")+"("+o+")");f.fileLoaded()},dataType:"text"})}else{f.scripts.push($(l).text())}});var h=$(g).children("data").children("languages").children("language");h.each(function(k,l){if($(l).attr("src")){f.languagesQueue.push($(l).attr("src"));var j=f.languagesQueue.length-1;f.toLoadCount++;$.ajax({url:f.path+$(l).attr("src"),success:function(m){f.languagesQueue[j]=$(m).children("language").first();f.fileLoaded()},error:function(m,o){f.languagesQueue[j]=null;f.issueWarning("error loading file "+$(l).attr("src")+"("+o+")");f.fileLoaded()},dataType:"xml"})}else{f.languagesQueue.push(l)}});this.toLoadCount++;this.fileLoaded()},fileLoaded:function(){this.toLoadCount--;var c=this.templatesQueue.length+this.scripts.length+this.languagesQueue.length;this.setProgress(((c-this.toLoadCount)/c)*50);if(this.toLoadCount==0){this.loadFiles()}},fileProcessed:function(){this.toProcessCount--;this.setProgress(50+(((this.toProcessAll-this.toProcessCount)/this.toProcessAll)*50))},loadFiles:function(){var e=this;this.setProgress(50);this.children={};this.toProcessAll=this.toProcessCount=this.templatesQueue.length+this.languagesQueue.length+this.scripts.length;for(var c=0;c<this.templatesQueue.length;c++){this.appendTemplates(this.templatesQueue[c],this,"");this.fileProcessed()}this.setProgress(100)},appendTemplates:function(e,c,g){var f=this;var h=0;$(e).children("army, group, element, deadend").each(function(k,p){h++;var m=p.nodeName.toLowerCase();var o=null;var j;if(j=$(p).attr("prototype")){o=f.templatesByPath[j];if(!o){f.issueWarning("cant find prototype "+j)}}var q=q=$(p).attr("id");if(!q&&o){q=o.id}if(!q){q=h}switch(m){case"element":var l=new a.ElementTemplate(c,q,o);break;case"group":var l=new a.GroupTemplate(c,q,o);break;case"army":var l=new a.ArmyTemplate(c,q,o);break;case"deadend":delete c.children[q];return;default:return}l._loadFromXml($(p));f.templatesByPath[g+q]=l;f.appendTemplates(p,l,g+q+".");if(l instanceof a.ArmyTemplate){f.armies[q]=l}})},save:function(){var c=b.buildXml({identity:this.identity});this.putFile("info",c);return true},loaded:function(){alert("loaded")}};return(b)}).call({})})(ArmyCalc);function acAddCSSRule(b,a,c){for(var f=0;f<document.styleSheets.length;f++){var j=document.styleSheets[f];var h=(j.cssRules||j.rules);var k=b.toLowerCase();for(var e=0,g=h.length;e<g;e++){if(h[e].selectorText&&(h[e].selectorText.toLowerCase()==k)){if(c!=null){h[e].style[a]=c;return}else{if(j.deleteRule){j.deleteRule(e)}else{if(j.removeRule){j.removeRule(e)}else{h[e].style.cssText=""}}}}}}var j=document.styleSheets[0]||{};if(j.insertRule){var h=(j.cssRules||j.rules);j.insertRule(b+"{ "+a+":"+c+"; }",h.length)}else{if(j.addRule){j.addRule(b,a+":"+c+";",0)}}}function acGetText(a){txt="";$(a).contents().each(function(){if((this.nodeType==3)&&(!this.isElementContentWhitespace)){txt+=this.wholeText}if((this.nodeType!=3)){txt+="<span class='trans "+$(this).attr("ln")+"'>"+$(this).text()+"</span>"}});return $.trim(txt)}(function(g){g.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","color","outlineColor"],function(a,b){g.fx.step[b]=function(c){if(!c.colorInit){c.start=h(c.elem,b);c.end=e(c.end);c.colorInit=true}c.elem.style[b]="rgb("+[Math.max(Math.min(parseInt((c.pos*(c.end[0]-c.start[0]))+c.start[0]),255),0),Math.max(Math.min(parseInt((c.pos*(c.end[1]-c.start[1]))+c.start[1]),255),0),Math.max(Math.min(parseInt((c.pos*(c.end[2]-c.start[2]))+c.start[2]),255),0)].join(",")+")"}});function e(a){var b;if(a&&a.constructor==Array&&a.length==3){return a}if(b=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(a)){return[parseInt(b[1]),parseInt(b[2]),parseInt(b[3])]}if(b=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(a)){return[parseFloat(b[1])*2.55,parseFloat(b[2])*2.55,parseFloat(b[3])*2.55]}if(b=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(a)){return[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]}if(b=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(a)){return[parseInt(b[1]+b[1],16),parseInt(b[2]+b[2],16),parseInt(b[3]+b[3],16)]}if(b=/rgba\(0, 0, 0, 0\)/.exec(a)){return f.transparent}return f[g.trim(a).toLowerCase()]}function h(a,c){var b;do{b=g.curCSS(a,c);if(b!=""&&b!="transparent"||g.nodeName(a,"body")){break}c="backgroundColor"}while(a=a.parentNode);return e(b)}var f={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]}})(jQuery);function acClone(b){var a=(this instanceof Array)?[]:{};for(i in b){if(typeof b[i]=="object"){a[i]=acClone(b[i])}else{a[i]=b[i]}}return a}function acPrintText(b){var a=window.open("","TrackHistoryData","width=420,height=225,top=250,left=345,toolbars=no,scrollbars=no,status=no,resizable=no");a.document.write(b);a.document.close();a.focus();a.print();a.close()}function acSandbox(a,b){new Function("window","with(window){"+a+"}")(b)};