function acAddCSSRule(b,a,c){for(var e=0;e<document.styleSheets.length;e++){var h=document.styleSheets[e];var g=(h.cssRules||h.rules);var j=b.toLowerCase();for(var d=0,f=g.length;d<f;d++){if(g[d].selectorText&&(g[d].selectorText.toLowerCase()==j)){if(c!=null){g[d].style[a]=c;return}else{if(h.deleteRule){h.deleteRule(d)}else{if(h.removeRule){h.removeRule(d)}else{g[d].style.cssText=""}}}}}}var h=document.styleSheets[0]||{};if(h.insertRule){var g=(h.cssRules||h.rules);h.insertRule(b+"{ "+a+":"+c+"; }",g.length)}else{if(h.addRule){h.addRule(b,a+":"+c+";",0)}}}function Element(){}function Element(){}function jsArmyCalc(b,a){calc={};calc.canvas=$(b);calc.canvas.attr("style","");calc.canvas.html("loading calc...");var c=$.ajax({url:a,async:false}).responseText;calc.canvas.html(c);calc.statusElem=calc.canvas.find("#acStatus");calc.submenuElem=calc.canvas.find(".submenu");calc.langSelect=calc.canvas.find("#acLang");calc.langSelect.change(function(){calc.setLang($(this).val())});calc.canvas.find("#acMaximize").click(function(){calc.setFullscreen(true);return false});calc.canvas.find("#acMinimize").click(function(){calc.setFullscreen(false);return false});calc.canvas.find("#acNew").click(function(){calc.newArmy();return false});Instance=function(f,e,d){this.name=f.name;this.clear=function(){this.child={}};this.data=f;this.append=function(i){if(!this.data.elements[i]){return}if(!this.instances[i]){this.instances[i]=[]}var h=$("<ul></ul>");var g=new Instance(this.data.elements[i],h);this.instances[i].push(g);anchor=$("<a href='#'>"+this.data.elements[i].name+"</a>");g.submenu=$("<ul><li>submenu</li></ul>");$.each(this.data.elements[i].elements,function(l,k){var j=$("<a href='#'>"+k.name+"</a>");j.click(function(){g.append(l)});g.submenu.append($("<li></li>").append(j))});this._ul.append($("<li></li>").append(anchor).append(h));calc.submenuElem.append(g.submenu);g.submenu.hide();anchor.click(function(){calc.submenuElem.children().hide();g.submenu.show()})};this._ul=e;this.instances={}};calc.army={maxCosts:{}};calc.units=[];calc.availableUnits={};calc.closePopup=function(){this.canvas.find("#acPopup").fadeOut();this.canvas.find("#acPopupBg").fadeOut()};calc.popup=function(f,d,e){this.canvas.find("#acPopupTitle").text(f);this.canvas.find("#acPopupContent").html("");this.canvas.find("#acPopupContent").append(d);if(e){this.canvas.find("#acClosePopup").hide()}else{this.canvas.find("#acClosePopup").show()}this.canvas.find("#acPopupBg").fadeIn();this.canvas.find("#acPopup").fadeIn();this.canvas.find("#acClosePopup").click(function(){calc.canvas.find("#acPopup").fadeOut();calc.canvas.find("#acPopupBg").fadeOut();return false})};calc.setStatus=function(d){this.statusElem.text(d)};calc.setLang=function(d){acAddCSSRule(".trans","display","none");if(this.lang){acAddCSSRule("."+this.lang+"","display","none")}this.lang=d;acAddCSSRule("."+d+"","display","inline")};calc.setStatus("no TWR file loaded");calc.setError=function(d){this.statusElem.html('<b style="color:red">'+d+"</b>")};xhrError=function(f,e,d){this.calc.setError(this.url+" - "+e+" - "+d)};getText=function(d){txt="";$(d).contents().each(function(){if((this.nodeType==3)&&(!this.isElementContentWhitespace)){txt+=this.wholeText}if((this.nodeType!=3)){txt+="<span class='trans "+$(this).attr("ln")+"'>"+$(this).text()+"</span>"}});return $.trim(txt)};calc.loadElements=function(d,e){if($(d).attr("src")){$.ajax({calc:calc,url:calc.twrurl+$(d).attr("src"),success:function(f){calc.loadElements($(f).children("elements"),e)},error:xhrError,dataType:"xml"})}else{$(d).children("element").each(function(){var f={};f.uid=$(this).children("uid").text();f.name=getText($(this).children("name"));f.description=getText($(this).children("description"));f.elements={};f.minCount=($(this).attr("minCount")?$(this).attr("minCount"):0);f.maxCount=($(this).attr("maxCount")?$(this).attr("maxCount"):null);f.stats={};$(this).children("stats").children("stat").each(function(){f.stats[$(this).attr("id")]=$(this).text()});calc.loadElements($(this).children("elements"),f.elements);e[f.uid]=f})}};calc.loadInfoXml=function(d,f,e){ruleset={};this.calc.langSelect.html();langSelect=this.calc.langSelect;$(d).children("ruleset").children("languages").children("language").each(function(){langSelect.append("<option value='"+$(this).attr("id")+"'"+($(this).attr("default")=="true"?" selected='true'":"")+">"+$(this).find("name").text()+"</option>");if($(this).attr("default")=="true"){calc.setLang($(this).attr("id"))}});d=$(d).children("ruleset");ruleset.version=$(d).attr("version");ruleset.uid=$(d).children("uid").text();ruleset.revision=$(d).children("revision").text();ruleset.name=getText($(d).children("name"));ruleset.description=getText($(d).children("description"));ruleset.costs={};$(d).children("costs").children("cost").each(function(){ruleset.costs[$(this).attr("id")]={name:getText($(this).children("name")),shortname:getText($(this).children("shortname")),unit:getText($(this).children("unit"))}});ruleset.stats={};$(d).children("stats").children("stat").each(function(){ruleset.stats[$(this).attr("id")]={display:($(this).attr("display")==true?true:false),name:getText($(this).children("name")),shortname:getText($(this).children("shortname")),"default":$(this).children("default").text()}});ruleset.defaultArmyName=getText($(d).children("defaultArmyName"));ruleset.defaultArmySize={};$(d).children("defaultArmySize").children("cost").each(function(){ruleset.defaultArmySize[$(this).attr("id")]=$(this).text()});ruleset.models={};calc.ruleset=ruleset;$(d).children("models").find("model").each(function(){model_id=$(this).attr("id");ruleset.models[model_id]={name:getText($(this).children("name")),"default":$(this).attr("default")=="true"};ruleset.models[model_id].elements={};ruleset.models[model_id].validator="";$.ajax({calc:calc,url:calc.twrurl+$(this).children("validator").attr("src"),success:function(g){ruleset.models[model_id].validator=g},error:xhrError,dataType:"text"});$(this).find("elements").each(function(){calc.loadElements(this,ruleset.models[model_id].elements)});ruleset.models[model_id].defaultArmyName=ruleset.defaultArmyName;ruleset.models[model_id].defaultArmySize=ruleset.defaultArmySize;if($(this).children("defaultArmyName").length){ruleset.models[model_id].defaultArmyName=getText($(this).children("defaultArmyName"))}$(this).children("defaultArmySize").children("cost").each(function(){ruleset.models[model_id].defaultArmySize[$(this).attr("id")]=$(this).text()})})};calc.calcLoadUnitsXml=function(d){console.log(d)};calc.loadTWR=function(d){this.twrurl=d;this.units=[];this.availableUnits=[];this.setStatus("loading "+d);$.ajax({calc:this,url:d+"info.xml",success:this.loadInfoXml,error:xhrError,dataType:"xml"})};calc.newArmy=function(){body=$("<div></div>");body.append("<p>"+this.ruleset.description+"</p>");modelSelect=$("<select></select>");for(id in this.ruleset.models){modelSelect.append("<option value='"+id+"'"+(this.ruleset.models[id]["default"]?" selected='true'":"")+">"+this.ruleset.models[id].name+"</option>")}createButton=$("<input type='button' value='create'/>");body.append(modelSelect);for(id in this.ruleset.costs){this.ruleset.costs[id].input=$("<input name='cost["+id+"]' value='0'/>");body.append($("<label>"+this.ruleset.costs[id].name+"</label>").append(this.ruleset.costs[id].input))}createButton.click(function(){calc.closePopup();calc.army=new Instance(ruleset.models[modelSelect.val()],$("#acUnits"),true);calc.army.maxCosts={};for(id in calc.ruleset.costs){calc.army.maxCosts[id]=calc.ruleset.costs[id].input.val()}calc.canvas.find("#acElements").html();$.each(calc.army.data.elements,function(f,e){var d=$("<a href='#'>"+e.name+"("+f+")</a>");calc.canvas.find("#acElements").append($("<li></li>").append(d));d.click(function(){calc.army.append(f)})})});body.append(createButton);this.popup("new army - "+this.ruleset.name,body)};calc.setFullscreen=function(d){$("body").toggleClass("acFullscreen",d);this.canvas.toggleClass("acFullscreen",d);this.canvas.find("#acMaximize").toggle(!d);this.canvas.find("#acMinimize").toggle(d)};return calc}function goodbye(a){}if(navigator.appName!="Microsoft Internet Explorer"){window.onbeforeunload=goodbye};